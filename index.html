<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide @latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght @400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #2563eb;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-12">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-20">
        <div class="max-w-xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span class="text-2xl">âœ¨</span> AI ë™ë¬¼ìƒ í…ŒìŠ¤íŠ¸
            </h1>
            <button id="resetBtn" class="p-2 hover:bg-slate-100 rounded-full transition-colors hidden">
                <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-500"></i>
            </button>
        </div>
    </header>

    <main class="max-w-xl mx-auto px-4 mt-8">
        <!-- Step 1: Upload -->
        <div id="uploadStep" class="space-y-6">
            <div class="text-center space-y-2">
                <h2 class="text-3xl font-extrabold tracking-tight">ë‹¹ì‹ ì€ ì–´ë–¤ ë™ë¬¼ìƒì¸ê°€ìš”?</h2>
                <p class="text-slate-500">ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì—¬ ì–¼êµ´ ì†ì— ìˆ¨ê²¨ì§„ ë™ë¬¼ ë§¤ë ¥ì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
            </div>

            <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-3xl p-12 bg-white flex flex-col items-center justify-center gap-4 cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all group">
                <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform">
                    <i data-lucide="upload" class="w-8 h-8"></i>
                </div>
                <div class="text-center">
                    <p class="font-semibold text-lg">ì‚¬ì§„ ì—…ë¡œë“œí•˜ê¸°</p>
                    <p class="text-sm text-slate-400">ì •ë©´ ì–¼êµ´ ì‚¬ì§„ì´ ê°€ì¥ ì •í™•í•´ìš”</p>
                </div>
                <input type="file" id="fileInput" class="hidden" accept="image/*">
            </div>

            <div class="grid grid-cols-3 gap-2" id="animalTypeIcons">
                <!-- Icons will be rendered here -->
            </div>
        </div>

        <!-- Step 2: Preview & Analysis -->
        <div id="previewStep" class="hidden space-y-8 fade-in">
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
                <div class="relative aspect-square">
                    <img id="previewImg" src="" alt="Preview" class="w-full h-full object-cover">
                    <div id="loadingOverlay" class="absolute inset-0 bg-white/70 backdrop-blur-sm hidden flex flex-col items-center justify-center">
                        <div class="spinner"></div>
                        <p class="mt-4 font-bold text-blue-900">ì–¼êµ´ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</p>
                    </div>
                </div>

                <div id="analyzeAction" class="p-6">
                    <button id="startAnalyzeBtn" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold text-lg hover:bg-blue-700 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        ê²°ê³¼ í™•ì¸í•˜ê¸°
                    </button>
                </div>

                <div id="errorBox" class="p-6 text-center hidden">
                    <div class="flex items-center justify-center gap-2 text-red-500 mb-4">
                        <i data-lucide="alert-circle" class="w-5 h-5"></i>
                        <span id="errorMessage" class="font-medium">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>
                    </div>
                    <button id="retryBtn" class="w-full py-4 bg-slate-100 text-slate-700 rounded-2xl font-bold hover:bg-slate-200 transition-colors">
                        ë‹¤ì‹œ ì‹œë„
                    </button>
                </div>
            </div>

            <!-- Result Section -->
            <div id="resultSection" class="hidden space-y-6 fade-in">
                <div id="resultCard" class="p-8 rounded-3xl border-2 shadow-lg relative overflow-hidden">
                    <div id="resultBgIcon" class="absolute top-0 right-0 p-4 opacity-10">
                        <span class="text-8xl"></span>
                    </div>
                    
                    <div class="relative z-10 text-center space-y-4">
                        <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/50 text-sm font-bold uppercase tracking-wider mb-2">
                            <i data-lucide="check-circle-2" class="w-4 h-4"></i> Match Found
                        </div>
                        
                        <h3 id="resultTitle" class="text-4xl font-black tracking-tight">
                            0% <span class="text-2xl font-bold">ë™ë¬¼ìƒ</span>
                        </h3>
                        
                        <div class="w-full bg-white/30 rounded-full h-3 overflow-hidden">
                            <div id="progressBar" class="bg-current h-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>

                        <p id="resultReason" class="text-lg leading-relaxed font-medium mt-6"></p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex gap-4">
                    <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center text-pink-500 shrink-0">
                        <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1">ë§¤ë ¥ í¬ì¸íŠ¸ í”¼ë“œë°±</h4>
                        <p id="positiveFeedback" class="text-slate-600 leading-relaxed italic"></p>
                    </div>
                </div>

                <div id="typeInfoBox" class="bg-blue-50 p-5 rounded-2xl border border-blue-100 flex items-start gap-3">
                    <i data-lucide="info" class="w-5 h-5 text-blue-400 shrink-0 mt-0.5"></i>
                    <p id="typeDescription" class="text-xs text-blue-700/80 leading-snug"></p>
                </div>

                <button id="retestBtn" class="w-full py-4 border-2 border-slate-200 text-slate-600 rounded-2xl font-bold hover:bg-slate-100 transition-colors">
                    ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸°
                </button>
            </div>
        </div>
    </main>

    <footer class="mt-20 text-center text-slate-400 text-sm">
        <p>Â© 2026 AI Animal Face Identity. All rights reserved.</p>
    </footer>

    <script type="module">
        // API í‚¤ëŠ” í™˜ê²½ì— ì˜í•´ ì£¼ì…ë©ë‹ˆë‹¤.
        const apiKey = import.meta.env.VITE_GEMINI_API_KEY;
        
        const ANIMAL_TYPES = {
            PUPPY: { name: 'ê°•ì•„ì§€ìƒ', description: 'ì„ í•œ ëˆˆë§¤, í° ëˆˆë™ì, ë™ê·¸ë€ ì½§ë§ìš¸, ë™ê¸€ë™ê¸€í•œ ì–¼êµ´í˜•ì´ íŠ¹ì§•ì´ë©° ìˆœí•˜ê³  ì¹œê·¼í•œ ì¸ìƒì„ ì¤ë‹ˆë‹¤.', color: 'bg-orange-100 text-orange-700 border-orange-200', icon: 'ğŸ¶' },
            CAT: { name: 'ê³ ì–‘ì´ìƒ', description: 'ìœ„ë¡œ ì˜¬ë¼ê°„ ëˆˆê¼¬ë¦¬, ë‚ ë µí•œ í„±ì„ , ë¾°ì¡±í•œ ëˆˆ ì•ë¨¸ë¦¬ê°€ íŠ¹ì§•ìœ¼ë¡œ ë„ë„í•˜ê³  ì„¸ë ¨ëœ ë§¤ë ¥ì„ ì¤ë‹ˆë‹¤.', color: 'bg-purple-100 text-purple-700 border-purple-200', icon: 'ğŸ±' },
            FOX: { name: 'ì‚¬ë§‰ì—¬ìš°ìƒ', description: 'ê°¸ë¦„í•œ ì–¼êµ´í˜•, ê¸´ ì½§ëŒ€, ê°€ë¡œë¡œ ê¸´ ëˆˆë§¤ë¡œ ë„ë„í•˜ë©´ì„œë„ ë§¤í˜¹ì ì¸ ë¶„ìœ„ê¸°ë¥¼ ìì•„ëƒ…ë‹ˆë‹¤.', color: 'bg-yellow-100 text-yellow-700 border-yellow-200', icon: 'ğŸ¦Š' },
            RABBIT: { name: 'í† ë¼ìƒ', description: 'ì‘ê³  ë™ê·¸ë€ ì½”, í†¡ íŠ€ì–´ë‚˜ì˜¨ ì•ë‹ˆ, ìˆœí•˜ê³  ê·€ì—¬ìš´ ì´ë¯¸ì§€ê°€ íŠ¹ì§•ì…ë‹ˆë‹¤.', color: 'bg-pink-100 text-pink-700 border-pink-200', icon: 'ğŸ°' },
            BEAR: { name: 'ê³°ìƒ', description: 'ë“¬ì§í•˜ê³  ì„ í•œ ì¸ìƒ, ë‘¥ê¸€ë‘¥ê¸€í•œ ì´ëª©êµ¬ë¹„ë¡œ í¸ì•ˆí•¨ì„ ì¤ë‹ˆë‹¤.', color: 'bg-amber-100 text-amber-700 border-amber-200', icon: 'ğŸ»' },
            DINO: { name: 'ê³µë£¡/ëŠ‘ëŒ€ìƒ', description: 'ëšœë ·í•œ ì´ëª©êµ¬ë¹„, ê°•í•œ ì¸ìƒ, ì§™ì€ ëˆˆì¹ì´ íŠ¹ì§•ì´ë©° ì¹´ë¦¬ìŠ¤ë§ˆ ë„˜ì¹˜ëŠ” ë§¤ë ¥ì„ ì¤ë‹ˆë‹¤.', color: 'bg-emerald-100 text-emerald-700 border-emerald-200', icon: 'ğŸ¦–' }
        };

        // DOM Elements
        const uploadStep = document.getElementById('uploadStep');
        const previewStep = document.getElementById('previewStep');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewImg = document.getElementById('previewImg');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const analyzeAction = document.getElementById('analyzeAction');
        const startAnalyzeBtn = document.getElementById('startAnalyzeBtn');
        const resultSection = document.getElementById('resultSection');
        const resetBtn = document.getElementById('resetBtn');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');
        const retryBtn = document.getElementById('retryBtn');

        let base64Image = "";

        // Initial setup
        function init() {
            lucide.createIcons();
            renderAnimalIcons();
        }

        function renderAnimalIcons() {
            const container = document.getElementById('animalTypeIcons');
            Object.values(ANIMAL_TYPES).forEach(type => {
                const div = document.createElement('div');
                div.className = "bg-white border border-slate-100 p-3 rounded-xl text-center shadow-sm";
                div.innerHTML = `<span class="text-2xl mb-1 block">${type.icon}</span><span class="text-xs font-medium text-slate-600">${type.name}</span>`;
                container.appendChild(div);
            });
        }

        // Image Handling
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    base64Image = reader.result.split(',')[1];
                    previewImg.src = reader.result;
                    uploadStep.classList.add('hidden');
                    previewStep.classList.remove('hidden');
                    resetBtn.classList.remove('hidden');
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            }
        };

        // Analysis Logic
        async function analyzeFace() {
            if (!base64Image) return;

            loadingOverlay.classList.remove('hidden');
            analyzeAction.classList.add('hidden');
            errorBox.classList.add('hidden');
            resultSection.classList.add('hidden');

            const systemPrompt = `
                ë‹¹ì‹ ì€ ì–¼êµ´ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì‚¬ì§„ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ 6ê°€ì§€ ë™ë¬¼ìƒ ì¤‘ í•˜ë‚˜ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”:
                1. ê°•ì•„ì§€ìƒ, 2. ê³ ì–‘ì´ìƒ, 3. ì‚¬ë§‰ì—¬ìš°ìƒ, 4. í† ë¼ìƒ, 5. ê³°ìƒ, 6. ê³µë£¡/ëŠ‘ëŒ€ìƒ.
                JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
                {
                  "animalKey": "PUPPY" | "CAT" | "FOX" | "RABBIT" | "BEAR" | "DINO",
                  "matchPercentage": 0-100,
                  "reason": "ë¶„ë¥˜ ì´ìœ  (í•œêµ­ì–´)",
                  "positiveFeedback": "ê¸ì •ì ì¸ ì¹­ì°¬ í”¼ë“œë°± (í•œêµ­ì–´)"
                }
            `;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: "ì´ ì‚¬ì§„ì˜ ì£¼ì¸ê³µì€ ì–´ë–¤ ë™ë¬¼ìƒì¸ê°€ìš”? ë¶„ì„ ê²°ê³¼ì™€ ì¹­ì°¬ì„ ë‹´ì•„ JSONìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”." },
                        { inlineData: { mimeType: "image/png", data: base64Image } }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
            };

            const fetchWithRetry = async (retries = 5, delay = 1000) => {
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }
                    );
                    if (!response.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                    return await response.json();
                } catch (err) {
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(retries - 1, delay * 2);
                    }
                    throw err;
                }
            };

            try {
                const data = await fetchWithRetry();
                const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (resultText) {
                    displayResult(JSON.parse(resultText));
                } else {
                    throw new Error('ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                errorMessage.innerText = "ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
                errorBox.classList.remove('hidden');
                analyzeAction.classList.remove('hidden');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function displayResult(data) {
            const type = ANIMAL_TYPES[data.animalKey];
            const resultCard = document.getElementById('resultCard');
            const resultBgIcon = document.getElementById('resultBgIcon');
            const progressBar = document.getElementById('progressBar');
            
            // Apply Styles
            resultCard.className = `p-8 rounded-3xl border-2 shadow-lg relative overflow-hidden ${type.color}`;
            resultBgIcon.querySelector('span').innerText = type.icon;
            
            document.getElementById('resultTitle').innerHTML = `${data.matchPercentage}% <span class="text-2xl font-bold">${type.name}</span>`;
            document.getElementById('resultReason').innerText = `"${data.reason}"`;
            document.getElementById('positiveFeedback').innerText = data.positiveFeedback;
            document.getElementById('typeDescription').innerText = type.description;
            
            resultSection.classList.remove('hidden');
            lucide.createIcons();

            setTimeout(() => {
                progressBar.style.width = `${data.matchPercentage}%`;
            }, 100);
        }

        function reset() {
            base64Image = "";
            previewImg.src = "";
            uploadStep.classList.remove('hidden');
            previewStep.classList.add('hidden');
            resetBtn.classList.add('hidden');
            resultSection.classList.add('hidden');
            analyzeAction.classList.remove('hidden');
            errorBox.classList.add('hidden');
            fileInput.value = "";
        }

        // Event Listeners
        startAnalyzeBtn.onclick = analyzeFace;
        retryBtn.onclick = analyzeFace;
        resetBtn.onclick = reset;
        document.getElementById('retestBtn').onclick = reset;

        init();
    </script>
</body>
</html>